{"version":3,"sources":["../src/createTransaction.js"],"names":["defaultsSignTransaction","lockTime","DEFAULT_LOCKTIME","sigHashType","SIGHASH_ALL","segwit","additionals","onDeviceStreaming","_e","onDeviceSignatureGranted","onDeviceSignatureRequested","createTransaction","transport","arg","inputs","associatedKeysets","changePath","outputScriptHex","initialTimestamp","expiryHeight","useTrustedInputForSegwit","undefined","a","e","statusCode","notify","loop","i","length","index","total","progress","isDecred","includes","isXST","startTime","Date","now","sapling","bech32","useBip143","nullScript","Buffer","alloc","nullPrevout","defaultVersion","writeUInt32LE","trustedInputs","regularOutputs","signatures","publicKeys","firstRun","resuming","targetTransaction","version","timestamp","getTrustedInputCall","getTrustedInputBIP143","getTrustedInput","outputScript","from","input","trustedInput","sequence","DEFAULT_SEQUENCE","push","value","outputs","nVersionGroupId","nExpiryHeight","extraData","map","script","prevout","result","r","path","publicKey","Math","floor","concat","OP_DUP","OP_HASH160","HASH_SIZE","OP_EQUALVERIFY","OP_CHECKSIG","pseudoTX","Object","assign","pseudoTrustedInputs","signature","witness","signatureSize","keySize","offset","slice","lockTimeBuffer","tmpScriptData","decredWitness","forEach","inputIndex","toString"],"mappings":"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","sourcesContent":["// @flow\n\nimport { log } from \"@ledgerhq/logs\";\nimport type Transport from \"@ledgerhq/hw-transport\";\nimport { hashPublicKey } from \"./hashPublicKey\";\nimport { getWalletPublicKey } from \"./getWalletPublicKey\";\nimport type { AddressFormat } from \"./getWalletPublicKey\";\nimport { getTrustedInput } from \"./getTrustedInput\";\nimport { startUntrustedHashTransactionInput } from \"./startUntrustedHashTransactionInput\";\nimport { serializeTransaction } from \"./serializeTransaction\";\nimport { getTrustedInputBIP143 } from \"./getTrustedInputBIP143\";\nimport { compressPublicKey } from \"./compressPublicKey\";\nimport { signTransaction } from \"./signTransaction\";\nimport { hashOutputFull, provideOutputFullChangePath } from \"./finalizeInput\";\nimport { getAppAndVersion } from \"./getAppAndVersion\";\nimport type { TransactionOutput, Transaction } from \"./types\";\nimport {\n  DEFAULT_LOCKTIME,\n  DEFAULT_SEQUENCE,\n  SIGHASH_ALL,\n  OP_DUP,\n  OP_HASH160,\n  HASH_SIZE,\n  OP_EQUALVERIFY,\n  OP_CHECKSIG,\n} from \"./constants\";\nimport { shouldUseTrustedInputForSegwit } from \"./shouldUseTrustedInputForSegwit\";\n\nexport type { AddressFormat };\n\nconst defaultsSignTransaction = {\n  lockTime: DEFAULT_LOCKTIME,\n  sigHashType: SIGHASH_ALL,\n  segwit: false,\n  additionals: [],\n  onDeviceStreaming: (_e) => {},\n  onDeviceSignatureGranted: () => {},\n  onDeviceSignatureRequested: () => {},\n};\n\n/**\n *\n */\nexport type CreateTransactionArg = {\n  inputs: Array<[Transaction, number, ?string, ?number]>,\n  associatedKeysets: string[],\n  changePath?: string,\n  outputScriptHex: string,\n  lockTime?: number,\n  sigHashType?: number,\n  segwit?: boolean,\n  initialTimestamp?: number,\n  additionals: Array<string>,\n  expiryHeight?: Buffer,\n  useTrustedInputForSegwit?: boolean,\n  onDeviceStreaming?: ({\n    progress: number,\n    total: number,\n    index: number,\n  }) => void,\n  onDeviceSignatureRequested?: () => void,\n  onDeviceSignatureGranted?: () => void,\n};\n\nexport async function createTransaction(\n  transport: Transport<*>,\n  arg: CreateTransactionArg\n) {\n  let {\n    inputs,\n    associatedKeysets,\n    changePath,\n    outputScriptHex,\n    lockTime,\n    sigHashType,\n    segwit,\n    initialTimestamp,\n    additionals,\n    expiryHeight,\n    useTrustedInputForSegwit,\n    onDeviceStreaming,\n    onDeviceSignatureGranted,\n    onDeviceSignatureRequested,\n  } = {\n    ...defaultsSignTransaction,\n    ...arg,\n  };\n\n  if (useTrustedInputForSegwit === undefined) {\n    try {\n      const a = await getAppAndVersion(transport);\n      useTrustedInputForSegwit = shouldUseTrustedInputForSegwit(a);\n    } catch (e) {\n      if (e.statusCode === 0x6d00) {\n        useTrustedInputForSegwit = false;\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  // loop: 0 or 1 (before and after)\n  // i: index of the input being streamed\n  // i goes on 0...n, inluding n. in order for the progress value to go to 1\n  // we normalize the 2 loops to make a global percentage\n  const notify = (loop, i) => {\n    const { length } = inputs;\n    if (length < 3) return; // there is not enough significant event to worth notifying (aka just use a spinner)\n    const index = length * loop + i;\n    const total = 2 * length;\n    const progress = index / total;\n    onDeviceStreaming({ progress, total, index });\n  };\n\n  const isDecred = additionals.includes(\"decred\");\n  const isXST = additionals.includes(\"stealthcoin\");\n  let startTime = Date.now();\n  const sapling = additionals.includes(\"sapling\");\n  const bech32 = segwit && additionals.includes(\"bech32\");\n  let useBip143 =\n    segwit ||\n    (!!additionals &&\n      (additionals.includes(\"abc\") ||\n        additionals.includes(\"gold\") ||\n        additionals.includes(\"bip143\"))) ||\n    (!!expiryHeight && !isDecred);\n  // Inputs are provided as arrays of [transaction, output_index, optional redeem script, optional sequence]\n  // associatedKeysets are provided as arrays of [path]\n  const nullScript = Buffer.alloc(0);\n  const nullPrevout = Buffer.alloc(0);\n  const defaultVersion = Buffer.alloc(4);\n  !!expiryHeight && !isDecred\n    ? defaultVersion.writeUInt32LE(sapling ? 0x80000004 : 0x80000003, 0)\n    : isXST\n    ? defaultVersion.writeUInt32LE(2, 0)\n    : defaultVersion.writeUInt32LE(1, 0); // Default version to 2 for XST not to have timestamp\n  const trustedInputs: Array<*> = [];\n  const regularOutputs: Array<TransactionOutput> = [];\n  const signatures = [];\n  const publicKeys = [];\n  let firstRun = true;\n  const resuming = false;\n  const targetTransaction: Transaction = {\n    inputs: [],\n    version: defaultVersion,\n    timestamp: Buffer.alloc(0),\n  };\n\n  const getTrustedInputCall =\n    useBip143 && !useTrustedInputForSegwit\n      ? getTrustedInputBIP143\n      : getTrustedInput;\n  const outputScript = Buffer.from(outputScriptHex, \"hex\");\n\n  notify(0, 0);\n\n  // first pass on inputs to get trusted inputs\n  for (let input of inputs) {\n    if (!resuming) {\n      const trustedInput = await getTrustedInputCall(\n        transport,\n        input[1],\n        input[0],\n        additionals\n      );\n      log(\"hw\", \"got trustedInput=\" + trustedInput);\n      let sequence = Buffer.alloc(4);\n      sequence.writeUInt32LE(\n        input.length >= 4 && typeof input[3] === \"number\"\n          ? input[3]\n          : DEFAULT_SEQUENCE,\n        0\n      );\n      trustedInputs.push({\n        trustedInput: true,\n        value: Buffer.from(trustedInput, \"hex\"),\n        sequence,\n      });\n    }\n\n    const { outputs } = input[0];\n    const index = input[1];\n    if (outputs && index <= outputs.length - 1) {\n      regularOutputs.push(outputs[index]);\n    }\n\n    if (expiryHeight && !isDecred) {\n      targetTransaction.nVersionGroupId = Buffer.from(\n        sapling ? [0x85, 0x20, 0x2f, 0x89] : [0x70, 0x82, 0xc4, 0x03]\n      );\n      targetTransaction.nExpiryHeight = expiryHeight;\n      // For sapling : valueBalance (8), nShieldedSpend (1), nShieldedOutput (1), nJoinSplit (1)\n      // Overwinter : use nJoinSplit (1)\n      targetTransaction.extraData = Buffer.from(\n        sapling\n          ? [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]\n          : [0x00]\n      );\n    } else if (isDecred) {\n      targetTransaction.nExpiryHeight = expiryHeight;\n    }\n  }\n\n  targetTransaction.inputs = inputs.map((input) => {\n    let sequence = Buffer.alloc(4);\n    sequence.writeUInt32LE(\n      input.length >= 4 && typeof input[3] === \"number\"\n        ? input[3]\n        : DEFAULT_SEQUENCE,\n      0\n    );\n    return {\n      script: nullScript,\n      prevout: nullPrevout,\n      sequence,\n    };\n  });\n\n  if (!resuming) {\n    // Collect public keys\n    const result = [];\n    for (let i = 0; i < inputs.length; i++) {\n      const r = await getWalletPublicKey(transport, {\n        path: associatedKeysets[i],\n      });\n      notify(0, i + 1);\n      result.push(r);\n    }\n    for (let i = 0; i < result.length; i++) {\n      publicKeys.push(\n        compressPublicKey(Buffer.from(result[i].publicKey, \"hex\"))\n      );\n    }\n  }\n\n  if (initialTimestamp !== undefined) {\n    targetTransaction.timestamp = Buffer.alloc(4);\n    targetTransaction.timestamp.writeUInt32LE(\n      Math.floor(initialTimestamp + (Date.now() - startTime) / 1000),\n      0\n    );\n  }\n\n  onDeviceSignatureRequested();\n\n  if (useBip143) {\n    // Do the first run with all inputs\n    await startUntrustedHashTransactionInput(\n      transport,\n      true,\n      targetTransaction,\n      trustedInputs,\n      true,\n      !!expiryHeight,\n      additionals,\n      useTrustedInputForSegwit\n    );\n\n    if (!resuming && changePath) {\n      await provideOutputFullChangePath(transport, changePath);\n    }\n\n    await hashOutputFull(transport, outputScript);\n  }\n\n  if (!!expiryHeight && !isDecred) {\n    await signTransaction(transport, \"\", lockTime, SIGHASH_ALL, expiryHeight);\n  }\n\n  // Do the second run with the individual transaction\n  for (let i = 0; i < inputs.length; i++) {\n    const input = inputs[i];\n    let script =\n      inputs[i].length >= 3 && typeof input[2] === \"string\"\n        ? Buffer.from(input[2], \"hex\")\n        : !segwit\n        ? regularOutputs[i].script\n        : Buffer.concat([\n            Buffer.from([OP_DUP, OP_HASH160, HASH_SIZE]),\n            hashPublicKey(publicKeys[i]),\n            Buffer.from([OP_EQUALVERIFY, OP_CHECKSIG]),\n          ]);\n    let pseudoTX = Object.assign({}, targetTransaction);\n    let pseudoTrustedInputs = useBip143 ? [trustedInputs[i]] : trustedInputs;\n    if (useBip143) {\n      pseudoTX.inputs = [{ ...pseudoTX.inputs[i], script }];\n    } else {\n      pseudoTX.inputs[i].script = script;\n    }\n\n    await startUntrustedHashTransactionInput(\n      transport,\n      !useBip143 && firstRun,\n      pseudoTX,\n      pseudoTrustedInputs,\n      useBip143,\n      !!expiryHeight && !isDecred,\n      additionals,\n      useTrustedInputForSegwit\n    );\n\n    if (!useBip143) {\n      if (!resuming && changePath) {\n        await provideOutputFullChangePath(transport, changePath);\n      }\n      await hashOutputFull(transport, outputScript, additionals);\n    }\n\n    if (firstRun) {\n      onDeviceSignatureGranted();\n      notify(1, 0);\n    }\n\n    const signature = await signTransaction(\n      transport,\n      associatedKeysets[i],\n      lockTime,\n      sigHashType,\n      expiryHeight,\n      additionals\n    );\n    notify(1, i + 1);\n\n    signatures.push(signature);\n    targetTransaction.inputs[i].script = nullScript;\n    if (firstRun) {\n      firstRun = false;\n    }\n  }\n\n  // Populate the final input scripts\n  for (let i = 0; i < inputs.length; i++) {\n    if (segwit) {\n      targetTransaction.witness = Buffer.alloc(0);\n      if (!bech32) {\n        targetTransaction.inputs[i].script = Buffer.concat([\n          Buffer.from(\"160014\", \"hex\"),\n          hashPublicKey(publicKeys[i]),\n        ]);\n      }\n    } else {\n      const signatureSize = Buffer.alloc(1);\n      const keySize = Buffer.alloc(1);\n      signatureSize[0] = signatures[i].length;\n      keySize[0] = publicKeys[i].length;\n      targetTransaction.inputs[i].script = Buffer.concat([\n        signatureSize,\n        signatures[i],\n        keySize,\n        publicKeys[i],\n      ]);\n    }\n    let offset = useBip143 && !useTrustedInputForSegwit ? 0 : 4;\n    targetTransaction.inputs[i].prevout = trustedInputs[i].value.slice(\n      offset,\n      offset + 0x24\n    );\n  }\n\n  const lockTimeBuffer = Buffer.alloc(4);\n  lockTimeBuffer.writeUInt32LE(lockTime, 0);\n\n  var result = Buffer.concat([\n    serializeTransaction(\n      targetTransaction,\n      false,\n      targetTransaction.timestamp,\n      additionals\n    ),\n    outputScript,\n  ]);\n\n  if (segwit && !isDecred) {\n    var witness = Buffer.alloc(0);\n    for (var i = 0; i < inputs.length; i++) {\n      var tmpScriptData = Buffer.concat([\n        Buffer.from(\"02\", \"hex\"),\n        Buffer.from([signatures[i].length]),\n        signatures[i],\n        Buffer.from([publicKeys[i].length]),\n        publicKeys[i],\n      ]);\n      witness = Buffer.concat([witness, tmpScriptData]);\n    }\n    result = Buffer.concat([result, witness]);\n  }\n\n  // FIXME: In ZEC or KMD sapling lockTime is serialized before expiryHeight.\n  // expiryHeight is used only in overwinter/sapling so I moved lockTimeBuffer here\n  // and it should not break other coins because expiryHeight is false for them.\n  // Don't know about Decred though.\n  result = Buffer.concat([result, lockTimeBuffer]);\n\n  if (expiryHeight) {\n    result = Buffer.concat([\n      result,\n      targetTransaction.nExpiryHeight || Buffer.alloc(0),\n      targetTransaction.extraData || Buffer.alloc(0),\n    ]);\n  }\n\n  if (isDecred) {\n    let decredWitness = Buffer.from([targetTransaction.inputs.length]);\n    inputs.forEach((input, inputIndex) => {\n      decredWitness = Buffer.concat([\n        decredWitness,\n        Buffer.from([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]),\n        Buffer.from([0x00, 0x00, 0x00, 0x00]), //Block height\n        Buffer.from([0xff, 0xff, 0xff, 0xff]), //Block index\n        Buffer.from([targetTransaction.inputs[inputIndex].script.length]),\n        targetTransaction.inputs[inputIndex].script,\n      ]);\n    });\n\n    result = Buffer.concat([result, decredWitness]);\n  }\n\n  return result.toString(\"hex\");\n}\n"],"file":"createTransaction.js"}